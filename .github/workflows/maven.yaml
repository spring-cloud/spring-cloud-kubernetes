name: github-workflow

on:
  push:
    branches: [ main, 2.1.x ]
  pull_request:
    branches: [ main, 2.1.x ]

jobs:
  build:
    runs-on: ubuntu-latest
    env:
      TESTCONTAINERS_REUSE_ENABLE: false
    steps:

      - name: checkout project
        uses: actions/checkout@v2

      - name: set env variables
        uses: ./.github/workflows/composites/env-variables

      - name: setup project jdk-17
        id: jdk_17
        uses: ./.github/workflows/composites/setup-jdk17
        if: env.BASE_BRANCH == 'main'

      - name: setup project jdk-8
        uses: ./.github/workflows/composites/setup-jdk1.8
        if: env.BASE_BRANCH == '2.1.x'

      - name: Show caches
        uses: actions/github-script@v6
        with:
          script: |
              const caches = await github.rest.actions.getActionsCacheList({
                owner: context.repo.owner,
                repo: context.repo.repo,
              })
              for (const cache of caches.data.actions_caches) {
                console.log(cache)
              }

      - name: restore spring-k8s-test-times-cache if it exists
        id: restore_cache
        uses: actions/cache/restore@v3
        with:
          path: /tmp/sorted.txt
          key: ${{ runner.os }}-spring-k8s-cache-of-test-times-${{ env.BRANCH_NAME }}

      - name: cache local maven repository
        uses: ./.github/workflows/composites/cache

      - name: maven build with dry-run for tests
        uses: ./.github/workflows/composites/maven-build-with-dry-run-for-tests

      - name: build controllers project
        uses: ./.github/workflows/composites/build-controllers-project
        if: env.BASE_BRANCH != '2.1.x'

      - name: build integration tests project
        uses: ./.github/workflows/composites/build-integration-tests-project
        if: env.BASE_BRANCH != '2.1.x'

      - name: save controller docker images
        uses: ./.github/workflows/composites/save-controller-images
        if: env.BASE_BRANCH != '2.1.x'

      - name: save integration tests docker images
        uses: ./.github/workflows/composites/save-integration-tests-images
        if: env.BASE_BRANCH != '2.1.x'

      - name: echo saved images
        uses: ./.github/workflows/composites/echo-saved-images
        if: env.BASE_BRANCH != '2.1.x'

      - name: upload docker images
        uses: ./.github/workflows/composites/upload-docker-images
        if: env.BASE_BRANCH != '2.1.x'

  # we need to run some test, so that K3s container is started and then all other instances will re-use this one.
  # Otherwise, (since we use static ports) there might be two instances starting at the same time, and ports might conflict
  # This does not run on '2.1.x' branch.
  fabric8_istio_integration_test:
    needs: build
    runs-on: ubuntu-latest

    steps:
      - name: checkout project
        uses: actions/checkout@v2

      - name: set env variables
        uses: ./.github/workflows/composites/env-variables

      - name: setup project
        uses: ./.github/workflows/composites/setup-jdk17
        if: env.BASE_BRANCH == 'main'

      - name: cache local maven repository
        uses: ./.github/workflows/composites/cache
        if: env.BASE_BRANCH != '2.1.x'

      - name: download docker images
        uses: ./.github/workflows/composites/download-docker-images
        if: env.BASE_BRANCH != '2.1.x'

      - name: echo saved images
        uses: ./.github/workflows/composites/echo-saved-images
        if: env.BASE_BRANCH != '2.1.x'

      - name: integration test fabric8 istio
        uses: ./.github/workflows/composites/fabric8-istio-integration-test
        if: env.BASE_BRANCH != '2.1.x'

  test:
    needs: [ build, fabric8_istio_integration_test ]
    runs-on: ubuntu-latest
    timeout-minutes: 60

    strategy:
      fail-fast: true
      matrix:
        current_index: [0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23, 24, 25, 26, 27, 28, 29, 30, 31]
        number_of_jobs: [32]

    steps:

      - name: testcontainers reuse support
        run: echo "testcontainers.reuse.enable=true" > ~/.testcontainers.properties

      - name: checkout project
        uses: actions/checkout@v2

      - name: set env variables
        uses: ./.github/workflows/composites/env-variables

      - name: setup project jdk-17
        uses: ./.github/workflows/composites/setup-jdk17
        if: env.BASE_BRANCH == 'main'

      - name: setup project jdk-8
        uses: ./.github/workflows/composites/setup-jdk1.8
        if: env.BASE_BRANCH == '2.1.x'

      - name: cache local maven repository
        uses: ./.github/workflows/composites/cache

      - name: download docker images
        uses: ./.github/workflows/composites/download-docker-images
        if: env.BASE_BRANCH != '2.1.x'

      - name: load docker images into local repo
        uses: ./.github/workflows/composites/load-docker-images
        if: env.BASE_BRANCH != '2.1.x'

      - name: download tests
        uses: actions/download-artifact@v3
        with:
          name: tests.txt
          path: /tmp

      - name: compute single step test bounds
        uses: ./.github/workflows/composites/test-bounds
        env:
          CURRENT_INDEX: ${{ matrix.current_index }}
          NUMBER_OF_JOBS: ${{ matrix.number_of_jobs }}

      - name: run and save individual test times
        env:
          CURRENT_INDEX: ${{ matrix.current_index }}
        if: env.BASE_BRANCH != '2.1.x'
        uses: ./.github/workflows/composites/run-and-save-test-times

  test_times:
    needs: [ test ]
    runs-on: ubuntu-latest

    steps:
      - name: checkout project
        uses: actions/checkout@v2

      - name: compute and save running time of tests
        if: env.BASE_BRANCH != '2.1.x'
        uses: ./.github/workflows/composites/test-times
