name: sets environment variables
description: sets environment variables
runs:
  using: "composite"
  steps:
    - name: set env variables
      shell: bash
      run: |
        
        baseRef=$GITHUB_BASE_REF
        if [[ ! -z $baseRef ]]; then
          echo "This is a PR to branch : $baseRef"
          echo "BASE_BRANCH=$(echo $baseRef)" >> $GITHUB_ENV
        else 
          raw=${{ github.ref }}
          echo "${raw}"
          branch=${raw##*/}
          echo "This is a merge to branch : ${branch}"
          echo "BASE_BRANCH=$(echo ${branch})" >> $GITHUB_ENV
        fi
        
        echo "BRANCH_NAME=$(echo $GITHUB_HEAD_REF)" >> $GITHUB_ENV
        echo "BASE_BRANCH_NAME=$(echo $GITHUB_BASE_REF)" >> $GITHUB_ENV
        echo "DOCKER_IMAGES_KEY=$(echo $GITHUB_RUN_ID)" >> $GITHUB_ENV

    - name : test
      shell: bash
      run: |
        echo  "base_branch : $BASE_BRANCH"
        PLAIN_TEST_CLASSNAMES=()
        baseBranch=$BASE_BRANCH
        if [[ $baseBranch == "2.1.x" ]]; then
          PLAIN_TEST_CLASSNAMES=($(find . -name '*.java' \
                        | grep 'src/test/java' \
                        | grep -v 'Fabric8IstioIT' \
                        | xargs grep -l '@Test' \
                        | xargs grep -L 'abstract class' \
                        | sed 's/.*src.test.java.//g' \
                        | sed 's@/@.@g' \
                        | sed 's/.\{5\}$//' \
                        | tr '\n' ' '))
        else
          PLAIN_TEST_CLASSNAMES=($(find . -name '*.java' \
                        | grep 'src/test/java' \
                        | grep -v 'Fabric8IstioIT' \
                        | xargs grep -l '@Test' \
                        | xargs grep -L 'abstract class' \
                        | sed 's/.*src.test.java.//g' \
                        | sed 's@/@.@g' \
                        | sed 's/.\{5\}$//' \
                        | tr '\n' ' '))
        fi
        
        echo $PLAIN_TEST_CLASSNAMES
